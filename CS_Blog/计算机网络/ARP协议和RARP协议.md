# 一、ARP协议简介

## 1. 认识MAC地址

IP地址是标识网络层的地址，MAC地址是标识数据链路层的地址

MAC地址的全称是 `Media Access Control Address`，译为`媒体访问控制地址`，它是网络上以太网或网络适配器的唯一标识符，MAC地址可以用来区分不同的网络接口

一个网卡的MAC地址都是唯一的，MAC地址长48位，结构如下：

![image-20210808214512015](https://raw.githubusercontent.com/gongruiyang/BlogImage/main/image-20210808214512015.png)

`第1位`：0表示单播地址，1表示多播地址

`第2位`：0表示全局地址，1表示本地地址

`第3位 至 第24位`：由IEEE管理并保证各厂家之间不会重复

`第25位 至 第48位`：由厂家管理并保证各个产品之间不会重复

> MAC地址如果处于不同的数据链路层，那么MAC地址重复也问题不大

## 2. 认识ARP协议

ARP协议的的全称是`Address Resolution Protocol`（地址解析协议），它的作用是实现从**IP地址到MAC地址之间的映射转换**，即询问IP地址对应的MAC地址的一种协议，ARP是IPv4中很重要的协议

> IPv6中使用的不是ARP，而是NDP协议（Neighbor Discovery Protocol），即邻居发现协议

## 3. ARP工作机制

* 前景：源主机和目的主机位于相同的链路之上

以`广播方式`向该链路上面的所有主机发送`ARP请求包`询问IP对应的MAC地址

![image-20210808222435913](https://raw.githubusercontent.com/gongruiyang/BlogImage/main/image-20210808222435913.png)

每个接收到该ARP请求包的主机或者路由器都会查看包中信息，对比自己的IP地址与包中的IP地址

如果`IP不相同`则会`丢弃该包`，如果`IP相同`则会将自己的MAC地址写入`ARP响应`包中发送给源主机

![image-20210808222941919](https://raw.githubusercontent.com/gongruiyang/BlogImage/main/image-20210808222941919.png)

# 二、ARP高速缓存

由于每一次从IP到MAC的转换都存在ARP的请求到响应，这中间的时延是不是很让人苦恼呢？

> 为了让ARP更加的高效，每个主机和路由器上都维护了一张`ARP缓存表`，这张表中有IP到MAC的映射关系，在每次请求查询IP对应的MAC时都会先到该表中去查询
>
> ARP缓存是有一定的期限的，过期后会清理缓存

* 在Linux下可以使用`arp命令`查看缓存表

```shell
[root@localhost gongruiyang]# arp
Address                  HWtype  HWaddress           Flags Mask            Iface
192.168.14.1             ether   00:50:56:c0:00:08   C                     ens32
gateway                  ether   00:50:56:ff:c1:bf   C                     ens32
192.168.14.254           ether   00:50:56:eb:a8:3b   C                     ens32
```

* Windows下查询缓存表

```shell
C:\Users\1111>arp -a

接口: 192.168.77.1 --- 0x4
  Internet 地址         物理地址              类型
  192.168.77.254        00-50-56-ed-38-17     动态
  192.168.77.255        ff-ff-ff-ff-ff-ff     静态
  224.0.0.2             01-00-5e-00-00-02     静态
  224.0.0.22            01-00-5e-00-00-16     静态
  224.0.0.251           01-00-5e-00-00-fb     静态
  224.0.0.252           01-00-5e-00-00-fc     静态
  239.11.20.1           01-00-5e-0b-14-01     静态
  239.255.255.250       01-00-5e-7f-ff-fa     静态
  255.255.255.255       ff-ff-ff-ff-ff-ff     静态

接口: 192.168.1.112 --- 0x9
  Internet 地址         物理地址              类型
  192.168.1.1           64-6e-97-6a-0f-3c     动态
  192.168.1.101         84-41-67-55-73-c3     动态
  192.168.1.102         84-fd-d1-a1-1a-2b     动态
  192.168.1.103         3a-07-00-3e-1d-89     动态
  192.168.1.105         34-79-16-18-4a-84     动态
  192.168.1.106         68-07-15-8d-e2-85     动态
  192.168.1.109         3a-68-bc-41-66-df     动态
  192.168.1.255         ff-ff-ff-ff-ff-ff     静态
  224.0.0.2             01-00-5e-00-00-02     静态
  224.0.0.22            01-00-5e-00-00-16     静态
  224.0.0.251           01-00-5e-00-00-fb     静态
  224.0.0.252           01-00-5e-00-00-fc     静态
  239.11.20.1           01-00-5e-0b-14-01     静态
  239.255.255.250       01-00-5e-7f-ff-fa     静态
  255.255.255.255       ff-ff-ff-ff-ff-ff     静态

接口: 192.168.14.1 --- 0x15
  Internet 地址         物理地址              类型
  192.168.14.128        00-0c-29-64-e6-75     动态
  192.168.14.254        00-50-56-eb-a8-3b     动态
  192.168.14.255        ff-ff-ff-ff-ff-ff     静态
```

# 三、ARP报文格式

ARP请求和应答分组格式如图4-3所示：

![image-20210809001356162](https://raw.githubusercontent.com/gongruiyang/BlogImage/main/image-20210809001356162.png)

前14个字节构成标准的以太网头部，以太网目的地址如果是`ff:ff:ff:ff:ff:ff`（全1）的情况下表示广播地址，在同一广播域下的所有以太网接口都可以接收到这些帧

* 以太网帧类型：值为`0x0806`表示是ARP请求或者ARP应答
* 硬件类型：表示`硬件地址的类型`，它的值为`1`表示`以太网地址`
* 协议类型：表示要映射的`协议地址类型`，它的值为`0x0800`表示`IP地址`
* 硬件地址长度：单位为字节，对于以太网上的IP地址的ARP请求和应答来说，该值为`6`
* 协议地址长度：单位为字节，对于以太网上的IP地址的ARP请求和应答来说，该值为`4`
* op：操作字段，四种类型：
* 发送端IP地址：
* 目的以太网地址：
* 目的IP地址：